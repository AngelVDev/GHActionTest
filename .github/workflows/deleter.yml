name: Delete branch by label

on:
  pull_request:
    branches: [main]
    types: [closed]

jobs:
  delete-branch:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.ME_TOKEN }}
      - name: Find and Delete Branch
        run: |
          # Get the most recently merged Pull Request
          PR_NUMBER=$(git log --merges --pretty=format:"%h %b" | grep 'Merge pull request #' | head -n 1 | awk '{print $5}' | sed 's/#//')
          
          # Get the labels of the Pull Request
          LABELS=$(gh pr view $PR_NUMBER --json labels -q .labels)
          
          # Check if the "delete branch" label exists
          if echo "$LABELS" | grep -q '"name": "delete branch"'; then
            # Extract the branch name from the PR
            BRANCH_NAME=$(gh pr view $PR_NUMBER --json headRefName -q .headRefName)
            # Delete the branch
            git push origin --delete "$BRANCH_NAME"
          fi
